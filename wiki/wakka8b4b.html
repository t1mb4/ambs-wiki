<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>

<!-- Mirrored from 78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS/RabotaSshljuzami/print by HTTrack Website Copier/3.x [XR&CO'2006], Wed, 25 Jul 2012 16:14:19 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=windows-1251"><!-- /Added by HTTrack -->
<head>
  <title>IpstudioWiki : ЧастыеВопросыИответыПоАМБС/РаботаСшлюзами</title>
<meta name="robots" content="noindex, nofollow" />
  <meta http-equiv="content-type" content="text/html; charset=windows-1251" />
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <link rel="stylesheet" type="text/css" href="http://78.46.73.113/wiki/themes/default/css/wakkaprint.css" />
</head>

<body>

<div class="header">
  IpstudioWiki : <a href="http://78.46.73.113/wiki/wakka.php?wakka=TextSearch?phrase=%D7%E0%F1%F2%FB%E5%C2%EE%EF%F0%EE%F1%FB%C8%EE%F2%E2%E5%F2%FB%CF%EE%C0%CC%C1%D1%2F%D0%E0%E1%EE%F2%E0%D1%F8%EB%FE%E7%E0%EC%E8">ЧастыеВопросыИответыПоАМБС/РаботаСшлюзами</a> 
</div>

<div class="pageBefore"><img src="http://78.46.73.113/wiki/images/z.gif" width="1" height="1" border="0" alt="" style="display:block" align="top" /></div><div class="page">
<a name="h105-1"></a><h1><!--notypo-->ЧаВО<!--/notypo--> по&nbsp;IP Studio AMBS</h1>
<br />
<strong> <a name=".." href="http://78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS&amp;v=17ko" class="" title="ЧастыеВопросыИответыПоАМБС/..">В оглавление</a> </strong><br />
<ul><li> <a name="obshhajainformacijapoambs" href="http://78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS/ObshhajaInformacijaPoAMBS&amp;v=p20" class="" title="ЧастыеВопросыИответыПоАМБС/Общая&nbsp;Информация&nbsp;По&nbsp;AMBS">Общая информация по&nbsp;IP Studio AMBS</a>
</li><li> <a name="voprosypoustanovkeambs" href="http://78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS/VoprosyPoustanovkeAMBS&amp;v=osy" class="" title="ЧастыеВопросыИответыПоАМБС/Вопросы&nbsp;Поустановке&nbsp;AMBS">Технические вопросы по&nbsp;системе</a>
</li><li> <a name="rabotacoperatorami" href="http://78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS/RabotaCoperatorami&amp;v=16or" class="" title="ЧастыеВопросыИответыПоАМБС/Работа&nbsp;Cоператорами">Операторы и&nbsp;их параметры</a>
</li><li> <a name="rabotastarifami" href="http://78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS/RabotaStarifami&amp;v=5yh" class="" title="ЧастыеВопросыИответыПоАМБС/Работа&nbsp;Старифами">Тарифные планы, валюты, цены и&nbsp;направления</a>
</li><li> <a name="rabotasshljuzami" href="http://78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS/RabotaSshljuzami&amp;v=xe5" class="" title="ЧастыеВопросыИответыПоАМБС/Работа&nbsp;Сшлюзами">Радиус: шлюзы, маршрутизация, трансляция</a> 
</li><li> <a name="mvtsvoprosy" href="http://78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS/MvtsVoprosy&amp;v=61q" class="" title="ЧастыеВопросыИответыПоАМБС/Mvts&nbsp;Вопросы">MVTS: конфиги, обновление, статистика, sip-hit</a> </li></ul>
<a name="h105-2"></a><h2>Радиус: шлюзы, маршрутизация, трансляция</h2>
<br />
<ul><li> <u><a href="#GWTT1" name="oGWTT1">Как сделать, чтобы исходящий номер заменялся на&nbsp;случайный номер из&nbsp;заданного списка?</a></u>
</li><li> <u><a href="#GWTT2" name="oGWTT2">Я блокирую некоторые направления операторов. Мера отбивает с&nbsp;кодом 21, как&nbsp;мне отдавать им&nbsp;другой код&nbsp;Q931?</a></u>
</li><li> <u><a href="#GWTT3" name="oGWTT3">Настроили связку Мера-АМБС, вызовы не&nbsp;проходят, отбой с&nbsp;кодом 206, при&nbsp;этом радиус обрабатывает звонок корректно, маршрут выдается. В&nbsp;чем проблема?</a></u>
</li><li> <u><a href="#GWTT4" name="oGWTT4">Не работает форма &laquo;Радиус он-лайн звонков&raquo;, как&nbsp;починить?</a></u>
</li><li> <u><a href="#GWTT5" name="oGWTT5">Добавил 2х простых операторов, тарифы есть, шлюзы правильные, но&nbsp;маршрут в&nbsp;Роут Тесте не&nbsp;выдается, почему?</a></u></li></ul>
 <br />
<hr noshade="noshade" size="1" />
<br />
<!--notypo--><a name="GWTT1" href="#GWTT1" title=""></a>
<!--/notypo--><strong>Вопрос: Как&nbsp;сделать, чтобы исходящий номер заменялся на&nbsp;случайный номер из&nbsp;заданного списка?</strong><br />
<br />
<strong>Ответ:</strong><br />
<br />
Замена исходящего номера на&nbsp;номер из&nbsp;списка делается следующим образом:<br />
<br />
<strong><!--notypo-->1.<!--/notypo--></strong> Список с&nbsp;номерами на&nbsp;которые будут заменятся АОНы вносится в&nbsp;базу данных АМБС в&nbsp;таблицу &#147;SRC_NUM_TRANSLATE&#148;. Пример:<br />
<!--notypo--><div class="code"><pre>mysql
use voip;
INSERT INTO SRC_NUM_TRANSLATE VALUES (<span style="color:#226622">#039;74951111111&#039;)<span style="color:#4400DD">,</span>(&#039;74952222222&#039;)<span style="color:#4400DD">,</span>(&#039;74953333333&#039;)<span style="color:#4400DD">,</span>(&#039;74954444444&#039;);</span>
quit</pre></div><!--/notypo--><br />
<strong><!--notypo-->2.<!--/notypo--></strong> У&nbsp;оператора (оригинатора), от&nbsp;которого приходит трафик нужно добавить трансляцию замены АОН-номера. <br />
<div class="indent">Для этого в&nbsp;поле &#147;<strong>Additional parameters</strong>&#148; шлюза нужно добавить трансляцию следующего вида:</div>
<!--notypo--><div class="code"><pre>in_src_translate<span style="color:#4400DD">=</span>.*/777</pre></div><!--/notypo--><br />
АМБС будет автоматически заменять все&nbsp;АОН-номера приходящие с&nbsp;данного шлюза на&nbsp;случайные номера из&nbsp;таблицы &#147;SRC_NUM_TRANSLATE&#148;.<br />
<br />
<em><strong><u>Примечание</u></strong>: Замена номера производится только когда IP&nbsp;Studio AMBS используется в&nbsp;режиме маршрутизации.</em><br />
<br />
<hr noshade="noshade" size="1" />
<br />
<!--notypo--><a name="GWTT2" href="#GWTT2" title=""></a>
<!--/notypo--><strong>Вопрос: Я&nbsp;блокирую некоторые направления операторов. Мера отбивает с&nbsp;кодом 21, как&nbsp;мне отдавать им&nbsp;другой код&nbsp;Q931?</strong><br />
<br />
<strong>Ответ:</strong><br />
<br />
У&nbsp;каждого оператора  (Operators &ndash; Edit operators) в&nbsp;параметрах, есть поле &#147;Q931 code&#148;.<br />
В&nbsp;этом поле можно задать,  какой код&nbsp;будет возвращаться данному оператору, в&nbsp;случае, если звонок отбит АМБС.<br />
<br />
Также нужно проверить конфиг Меры(meraproxy.cfg) секцию Radius. <br />
Должны присутствовать следующие строки:<br />
<!--notypo--><div class="code"><pre>q931_h323_disconnect_cause<span style="color:#4400DD">=</span>1
suppress_Q931_cause<span style="color:#4400DD">=</span>0</pre></div><!--/notypo--><br />
<hr noshade="noshade" size="1" />
<br />
<!--notypo--><a name="GWTT3" href="#GWTT3" title=""></a>
<!--/notypo--><strong>Вопрос: Настроили связку Мера-АМБС, вызовы не&nbsp;проходят, отбой с&nbsp;кодом 206, при&nbsp;этом радиус обрабатывает звонок корректно, маршрут выдается. В&nbsp;чем проблема?</strong><br />
<br />
<strong>Ответ:</strong><br />
<br />
Пример вызова с&nbsp;ошибкой: <br />
<!--notypo--><div class="code"><pre>Fri Apr 16 12:45:16 2010<span style="color:#4400DD">,</span> HOST<span style="color:#4400DD">=</span>192.168.0.2<span style="color:#4400DD">,</span> DST-NUMBER-IN<span style="color:#4400DD">=</span>74951231231<span style="color:#4400DD">,</span> .....<span style="color:#4400DD">,</span> DST-NUMBER-OUT<span style="color:#4400DD">=</span>74951231231<span style="color:#4400DD">,</span> .....<span style="color:#4400DD">,</span> DST-NUMBER-BILL<span style="color:#4400DD">=</span>74951231231<span style="color:#4400DD">,</span> 
SRC-IP<span style="color:#4400DD">=</span>10.10.10.1:28367<span style="color:#4400DD">,</span> DST-IP<span style="color:#4400DD">=</span>11.11.11.1:1720<span style="color:#4400DD">,</span> ......<span style="color:#4400DD">,</span> DIALPEER-NAME<span style="color:#4400DD">=</span>RADIUS_PEER<span style="color:#4400DD">,</span> .....<span style="color:#4400DD">,</span> ELAPSED-TIME<span style="color:#4400DD">=</span>0<span style="color:#4400DD">,</span> .....<span style="color:#4400DD">,</span> DISCONNECT-CODE-LOCAL<span style="color:#4400DD">=</span>206<span style="color:#4400DD">,</span> 
DISCONNECT-CODE-Q931<span style="color:#4400DD">=</span>3<span style="color:#4400DD">,</span> ......</pre></div><!--/notypo--><br />
Пример радиус-лога:<br />
<!--notypo--><div class="code"><pre>Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)IP 10.10.10.1 number 74951231231
Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)authorize 4
Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)chek ip 10.10.10.1  in mera 192.168.0.2 my oper_id <span style="color:#4400DD">=</span> 4<span style="color:#4400DD">,</span> dst_num <span style="color:#4400DD">=</span> 74951231231
Fri Apr 16 09:40:00 2010: INFO: proc(1:0)my_oper_id elapsed time <span style="color:#4400DD">=</span> 0.017494 seconds
Fri Apr 16 09:40:00 2010: INFO: proc(1:0)cache_key<span style="color:#4400DD">=</span><span style="color:#226622">#039;4:7495:2&#039;</span>
Fri Apr 16 09:40:00 2010: INFO: proc(1:0)cache_name<span style="color:#4400DD">=</span><span style="color:#226622">#039;ARRAY(0xce3b750)&#039;</span>
Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)Cache found
Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)10.10.10.1/xpgk
Fri Apr 16 09:40:00 2010: INFO: proc(1:0)retun arr count<span style="color:#4400DD">=</span>1
Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)Term_GW_2/1/0000/74951231231/0000/74951231231
Fri Apr 16 09:40:00 2010: INFO: proc(1:0)retun arr count<span style="color:#4400DD">=</span>2
Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)authorize 5 route done
Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)authorize 6 finish
Fri Apr 16 09:40:00 2010: INFO: proc(1:0)routing elapsed time <span style="color:#4400DD">=</span> 0.02016 seconds
Fri Apr 16 09:40:00 2010: NOTICE: proc(1:0)Access accepted<span style="color:#4400DD">,</span> return code <span style="color:#4400DD">=</span> 0</pre></div><!--/notypo--><br />
т.е. радиус обработал звонок, выдал маршрут, но&nbsp;мера отбила с&nbsp;кодом 206.<br />
<br />
При&nbsp;детальной проверке обмена пакетами между серверами АМБС-Мерой видно, что&nbsp;пакеты идут только в&nbsp;сторону АМБС:<br />
<!--notypo--><div class="code"><pre>[root@AMBS radius<span style="color:#226622"># tcpdump -qnnt host 192.168.0.2</span>
arp who-has 192.168.0.10 tell 192.168.0.2
arp reply 192.168.0.10 is-at 00:a0:c9:2b:77:df
IP 192.168.0.2.1647 &gt; 192.168.0.10.1814: UDP<span style="color:#4400DD">,</span> length 422
IP 192.168.0.2.1814 &gt; 192.168.0.10.1647: UDP<span style="color:#4400DD">,</span> length 100
IP 192.168.0.2.1645 &gt; 192.168.0.10.1812: UDP<span style="color:#4400DD">,</span> length 508
IP 192.168.0.2.1645 &gt; 192.168.0.10.1812: UDP<span style="color:#4400DD">,</span> length 508
arp who-has  192.168.0.2 tell 192.168.0.10
arp reply  192.168.0.2 is-at 00:16:ec:01:ef:22</pre></div><!--/notypo--><br />
где,  192.168.0.2 &ndash; сервер Меры<br />
<ol type="1"><li>168.0.10 &ndash; сервер АМБС</li></ol>
<br />
При&nbsp;проверке радиус процессов видим, что&nbsp;исполняется всего 4 процесса (1 родитель + 3 дочерних):<br />
<!--notypo--><div class="code"><pre>[root@AMBS radius<span style="color:#226622"># ps ax <span style="color:#4400DD">|</span> grep rad</span>
29295 ?        S&lt;s    0:00 /usr/local/billing/bin/radiusd -config_file /usr/local/billing/radius/radius.cfg -pid_file /usr/local/billing/radius/radius.pid
29305 ?        S&lt;s    0:00 /usr/local/bin/memcached -d -u ipstudio -l 127.0.0.1 -p 22331 -m 128 -P /usr/local/billing/radius/memcache.pid
29306 ?        S&lt;     0:00 /usr/local/billing/bin/radiusd -config_file /usr/local/billing/radius/radius.cfg -pid_file /usr/local/billing/radius/radius.pid
29307 ?        S&lt;     0:00 /usr/local/billing/bin/radiusd -config_file /usr/local/billing/radius/radius.cfg -pid_file /usr/local/billing/radius/radius.pid
29308 ?        S&lt;     0:00 /usr/local/billing/bin/radiusd -config_file /usr/local/billing/radius/radius.cfg -pid_file /usr/local/billing/radius/radius.pid</pre></div><!--/notypo--><br />
Что&nbsp;подтверждает и&nbsp;содержимое конфигурации радиуса:<br />
<!--notypo--><div class="code"><pre>[root@AMBS radius<span style="color:#226622"># cat radius.cfg</span>

MaxChildren  3

<span style="color:#226622"># User a lower trace level in production systems:</span>
LogFile         %L/cplog%y%m%d.%H
Trace  3
AuthPort  1812
AcctPort  1813
RoutePort 1814
AcctCnt   2
AuthCnt   2
RouteCnt  4
multiple_process 1</pre></div><!--/notypo--><br />
Однако, здесь же&nbsp;кроется и&nbsp;сама ошибка.<br />
Максимальное количество дочерних процессов задано &ndash; 3:<br />
<!--notypo--><div class="code"><pre>MaxChildren  3</pre></div><!--/notypo--><br />
В&nbsp;то время как&nbsp;их&nbsp;распределение между задачами авторизации, аккаунтинга и&nbsp;роутинга осталось из&nbsp;расчета на&nbsp;8 процессов:<br />
<!--notypo--><div class="code"><pre>AcctCnt   2
AuthCnt   2
RouteCnt  4</pre></div><!--/notypo--><br />
<strong>Решение: </strong><br />
Если мы&nbsp;установим максимальное число дочерних процесса &ndash; 8:<br />
<!--notypo--><div class="code"><pre>MaxChildren  8</pre></div><!--/notypo--><br />
и&nbsp;перезагрузим радиус все&nbsp;заработает как&nbsp;положено.<br />
<br />
<em><u>Примечание</u>: При&nbsp;уменьшении общего числа дочерних процессов следует также уменьшать и&nbsp;распределение этих процессов между задачами.</em><br />
<br />
Пример, для&nbsp;3 дочерних процессов конфиг должен был&nbsp;выглядеть как:<br />
<!--notypo--><div class="code"><pre>MaxChildren  3
AcctCnt   1
AuthCnt   1
RouteCnt  1</pre></div><!--/notypo--><br />
<br />
<hr noshade="noshade" size="1" />
<br />
<!--notypo--><a name="GWTT4" href="#GWTT4" title=""></a>
<!--/notypo--><strong>Вопрос: Не&nbsp;работает форма &laquo;Радиус он-лайн звонков&raquo;, как&nbsp;починить?</strong><br />
<br />
<strong>Ответ:</strong><br />
<br />
Установлен разный <em>secret</em>-ключ для&nbsp;обмена данными между Мерой и&nbsp;Радиусом. <br />
Проверьте <em>secret</em> в&nbsp;следующих местах:<br />
1. Форма &#147;<em>Equipments &ndash; MVTS Servers</em>&#148; у&nbsp;Меры с&nbsp;которой не&nbsp;показывается статистика по&nbsp;радиусу, поле &#147;<em>Radius key</em>&#148;<br />
2. Конфиг Радиуса, на&nbsp;сервере АМБС в&nbsp;файле <em>billing/radius/radius.cfg</em>, поле &#147;<em>Secret</em>&#148;<br />
3. Конфиг Меры, на&nbsp;сервере Меры в&nbsp;файле <em>mvts/cfg/meraproxy.cfg</em>, в&nbsp;секции <em>[Radius]</em> поле  &#147;<em>secret</em>&#148;<br />
<br />
Поправьте ключ на&nbsp;правильное значение и&nbsp;перезагрузите Радиус или&nbsp;Меру, в&nbsp;зависимости от&nbsp;того, в&nbsp;какой конфиг вносили изменения.<br />
<br />
<hr noshade="noshade" size="1" />
<!--notypo--><a name="GWTT5" href="#GWTT5" title=""></a>
<!--/notypo--><strong>Вопрос: Добавил 2х простых операторов, тарифы есть, шлюзы правильные, но&nbsp;маршрут в&nbsp;Роут Тесте не&nbsp;выдается, почему?</strong><br />
<br />
<strong>Ответ:</strong><br />
<br />
В&nbsp;форме Роут Тест:<br />
1. Включите параметры показывать закрытые и&nbsp;дорогие маршруты<br />
2. Включите вывод дебага на&nbsp;экран, по&nbsp;лог-ам часто можно определить чего не&nbsp;хватает для&nbsp;работы. <br />
3. Выключите фаерволл, возможно заблокирован порт для&nbsp;обмена информацией с&nbsp;кэшем (по умолчанию: memcache_port=22331).<br />
<br />
<hr noshade="noshade" size="1" /></div>
</body>
<!-- Mirrored from 78.46.73.113/wiki/wakka.php?wakka=ChastyeVoprosyIotvetyPoAMBS/RabotaSshljuzami/print by HTTrack Website Copier/3.x [XR&CO'2006], Wed, 25 Jul 2012 16:14:19 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=windows-1251"><!-- /Added by HTTrack -->
</html>